<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.2/css/bootstrap.min.css" integrity="sha384-Smlep5jCw/wG7hdkwQ/Z5nLIefveQRIY9nfy6xoR1uRYBtpZgI6339F5dgvm/e9B" crossorigin="anonymous">
    <script src="https://code.jquery.com/jquery-3.3.1.min.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/gh/ethereum/web3.js@1.0.0-beta.34/dist/web3.min.js" type="text/javascript"></script>
    <title>Validator example</title>
  </head>

  <body>
    <div class="container">
      <div class="row">
        <div class="col-sm-12">
          <h1>Validator example</h1>
        </div>
      </div>
      <div class="row">
        <div class="col-sm-12">
          <input id="address" placeholder="Input smart contract address" class="form-control form-control-lg">
          <input id="token" placeholder="Input valid token" class="form-control form-control-lg invisible">
          <button class="m-a btn btn-primary" id="validate">Validate</button>
        <div class="col-sm-12"></div>
      </div>
      <div class="row">
          <div class="col-sm-12" id="outcome">
          </div>
      </div>
    </div>
  </body>

  <script>
  
  window.addEventListener('load', async () => {
    if (window.ethereum) {
        window.web3 = new Web3(ethereum);
        try {
            await ethereum.enable();
        } catch (error) {
          $("#outcome").text('No web3 provider. Install Metamask.');
        }
    }
    else if (window.web3) {
        window.web3 = new Web3(web3.currentProvider);
    }
    else {
      $("#outcome").text('No web3 provider. Install Metamask.');
    }

    $('#validate').click(async function(){
      const addr = $('#address').val();
      const token = $('#token').val();
      if(token !== '') {

      } else if (await baseValidation(1, addr))  {
        $("#outcome").html('Is a contract');
        if (await baseValidation(2, addr) && await baseValidation(3, addr)) {
          if (await baseValidation(4, addr))  {
            const validId = await getTokenId(addr);
            const owner = await getTokenOwner(addr, validId);
          } else {
            $("#token").removeClass('invisible');
            $("#outcome").html('No enumerable extension. Input a valid token ID.');
          }
        } else {
          $("#outcome").html('Not erc721 contract.');
        }
      } else {
        $("#outcome").html('Is not a contract');
      }
    });
  });

  async function baseValidation(test, addr) {
    const abi = [{"inputs":[{"name":"_caseId","type":"uint256"},{"name":"_target","type":"address"}],"payable":false,"stateMutability":"nonpayable","type":"constructor"}];
    const bytecode = '0x608060405234801561001057600080fd5b506040516040806102bd8339810180604052604081101561003057600080fd5b508051602090910151600182141561005657610051816100a760201b60201c565b6100a0565b816002141561006e57610051816100cc60201b60201c565b8160031415610086576100518161016860201b60201c565b816004141561009e57610051816101eb60201b60201c565bfe5b5050610274565b6100c3816001600160a01b031661026e60201b6100091760201c565b6100c957fe5b50565b604080517f01ffc9a700000000000000000000000000000000000000000000000000000000808252600482015290516000916001600160a01b038416916301ffc9a791602480820192602092909190829003018186803b15801561012f57600080fd5b505afa158015610143573d6000803e3d6000fd5b505050506040513d602081101561015957600080fd5b505190508061016457fe5b5050565b604080517f01ffc9a70000000000000000000000000000000000000000000000000000000081527f80ac58cd00000000000000000000000000000000000000000000000000000000600482015290516000916001600160a01b038416916301ffc9a791602480820192602092909190829003018186803b15801561012f57600080fd5b604080517f01ffc9a70000000000000000000000000000000000000000000000000000000081527f780e9d6300000000000000000000000000000000000000000000000000000000600482015290516000916001600160a01b038416916301ffc9a791602480820192602092909190829003018186803b15801561012f57600080fd5b3b151590565b603b806102826000396000f3fe6080604052600080fd5b3b15159056fea165627a7a723058202cf6c3268162b39aabc886838fdf4803288299d95ab055a65746f04b3cb7334f0029';
    const basicValidator = new web3.eth.Contract(abi, {
        from: '0xe96D860C8BBB30F6831E6E65d327295B7A0C524f', // default from address
    });
    return new Promise(async (resolve, reject) => {
      await basicValidator.deploy({
          data: bytecode,
          arguments: [test, addr]
      }).estimateGas((err, gas) => {
        if (!err) {
          resolve(true);
        } else if (String(err).includes('gas required exceeds allowance or always failing transaction')) {
          resolve(false);
        } else {
          resolve(false);
        }
      }).catch((e) => resolve(false));
    });
  }

  async function getTokenId(addr) {
      const abi = [{"constant":true,"inputs":[{"name":"_index","type":"uint256"}],"name":"tokenByIndex","outputs":[{"name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"}];
      const erc721Enumerable = new web3.eth.Contract(abi, addr, {
          from: '0xe96D860C8BBB30F6831E6E65d327295B7A0C524f', // default from address
      });
      return new Promise(async (resolve, reject) => {
        await erc721Enumerable.methods.tokenByIndex(0).call()
        .then((id) => resolve(id))
        .catch((e) => resolve(null));
      });
  }

  async function getTokenOwner(addr, id) {
      const abi = [{"constant":true,"inputs":[{"name":"_tokenId","type":"uint256"}],"name":"ownerOf","outputs":[{"name":"","type":"address"}],"payable":false,"stateMutability":"view","type":"function"}];
      const erc721 = new web3.eth.Contract(abi, addr, {
          from: '0xe96D860C8BBB30F6831E6E65d327295B7A0C524f', // default from address
      });
      return new Promise(async (resolve, reject) => {
        await erc721.methods.ownerOf(id).call()
        .then((id) => resolve(id))
        .catch((e) => resolve(null));
      });
  }

  async function checkSafeTransfer(addr, owner, id, test) {
   /* const abi = [{"constant":false,"inputs":[{"name":"_from","type":"address"},{"name":"_to","type":"address"},{"name":"_tokenId","type":"uint256"}],"name":"safeTransferFrom","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":false,"inputs":[{"name":"_from","type":"address"},{"name":"_to","type":"address"},{"name":"_tokenId","type":"uint256"},{"name":"_data","type":"bytes"}],"name":"safeTransferFrom","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"}];
      const erc721 = new web3.eth.Contract(abi, addr);
      return new Promise(async (resolve, reject) => {
        await erc721.methods.safeTransferFrom(owner, , id).estimateGas({ from: owner }, (err, gas) => {
          if (!err) {
            resolve(true);
          } else if (String(err).includes('gas required exceeds allowance or always failing transaction')) {
            resolve(false);
          } else {
            resolve(false);
          }
        }).catch((e) => resolve(false));
      });*/
  }
  </script>
</html>
